{# templates/library/_collection_node.html #}
<div class="accordion-item">
  <h2 class="accordion-header" id="heading-{{ node.collection.id }}">
    <button class="accordion-button {% if not open %}collapsed{% endif %}" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapse-{{ node.collection.id }}"
            aria-expanded="{% if open %}true{% else %}false{% endif %}"
            aria-controls="collapse-{{ node.collection.id }}">
      <div class="d-flex justify-content-between w-100 pe-3">
        <span class="fw-semibold">{{ node.collection.name }}</span>
        <span class="text-muted small">
          {% if node.documents %}{{ node.documents|length }} doc{% endif %}
        </span>
      </div>
    </button>
  </h2>

  <div id="collapse-{{ node.collection.id }}" class="accordion-collapse collapse {% if open %}show{% endif %}"
       aria-labelledby="heading-{{ node.collection.id }}">
    <div class="accordion-body">

      {% if node.documents %}
        <div class="list-group mb-3">
          {% for doc in node.documents %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div>
                  <div class="fw-semibold">{{ doc.title }}</div>

                  <div class="d-flex flex-wrap gap-2 mt-2">
                    {% if doc.doc_type %}
                      <span class="badge text-bg-light border">{{ doc.get_doc_type_display|default:doc.doc_type }}</span>
                    {% endif %}
                    {% if doc.confidential %}
                      <span class="badge text-bg-danger">Confidentiel</span>
                    {% endif %}
                    {% if doc.reference %}
                      <span class="badge text-bg-secondary">Ref: {{ doc.reference }}</span>
                    {% endif %}
                    {% if doc.allowed_groups.count %}
                      <span class="badge text-bg-warning">Restreint</span>
                    {% endif %}
                  </div>

                  <div class="text-muted small mt-2">
                    {% if doc.file %}{{ doc.file.size|filesizeformat }}{% endif %}
                    {% if doc.created_at %} • {{ doc.created_at|date:"d/m/Y" }}{% endif %}
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2">
                  <a href="{{ doc.url }}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm">Ouvrir</a>
                  <a href="{% url 'secure_download' doc.id %}" class="btn btn-primary btn-sm">Télécharger</a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if node.children %}
        <div class="accordion" id="accordion-children-{{ node.collection.id }}">
          {% for child in node.children %}
            {% include "library/_collection_node.html" with node=child open=False only %}
          {% endfor %}
        </div>
      {% endif %}

    </div>
  </div>
</div>
