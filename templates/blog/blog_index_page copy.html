{% extends "blog/blog_base.html" %}
{% load wagtailcore_tags wagtailimages_tags %}

{% block blog_content %}

<!-- ====================== HEADER ====================== -->
<header class="d-flex align-items-end justify-content-between mb-4">
  <div>
    <h1 class="h3 mb-1">Articles</h1>
    {% if active_cat or active_tag %}
      <div class="text-muted small">
        {% if active_cat %}<span class="badge bg-light text-dark border me-1">Catégorie : {{ active_cat }}</span>{% endif %}
        {% if active_tag %}<span class="badge bg-light text-dark border">Tag : {{ active_tag }}</span>{% endif %}
      </div>
    {% endif %}
  </div>
</header>

<!-- ====================== GRID ====================== -->
{% if posts %}
  <div class="row g-4">
    {% for article in posts %}
      {% with post=article.specific %}
      <div class="col-12 col-md-6 col-lg-4">
        <article class="card h-100 shadow-sm border-0" itemscope itemtype="https://schema.org/BlogPosting">
          {% if post.image %}
            <a href="{{ post.url }}" class="ratio ratio-16x9 card-img-top overflow-hidden">
              {# Renditions + srcset pour rétine/perf #}
              {% image post.image fill-480x270 format-webp as img_sm %}
              {% image post.image fill-960x540 format-webp as img_lg %}
              <img
                src="{{ img_sm.url }}"
                srcset="{{ img_sm.url }} 480w, {{ img_lg.url }} 960w"
                sizes="(max-width: 576px) 100vw, (max-width: 992px) 50vw, 33vw"
                alt="{{ post.image.title }}"
                class="w-100 h-100 object-fit-cover"
                loading="lazy"
                itemprop="image">
            </a>
          {% endif %}

          <div class="card-body d-flex flex-column">
            <h2 class="h5 card-title mb-2" itemprop="headline">
              <a href="{{ post.url }}" class="stretched-link text-decoration-none">{{ post.title }}</a>
            </h2>

            <div class="text-muted small mb-2 d-flex align-items-center gap-2">
              {% if post.date %}
                <time datetime="{{ post.date|date:'Y-m-d' }}" itemprop="datePublished">
                  {{ post.date|date:"j F Y" }}
                </time>
              {% endif %}

              {# Affiche la première catégorie si dispo #}
              {% if post.categories.all %}
                {% with cat=post.categories.all.0 %}
                  <span class="vr mx-1 d-none d-sm-inline"></span>
                  <a href="?cat={{ cat.slug }}{% if request.GET.tag %}&tag={{ request.GET.tag|urlencode }}{% endif %}"
                     class="badge bg-primary-subtle text-primary border border-primary-subtle text-decoration-none">
                    {{ cat.name }}
                  </a>
                {% endwith %}
              {% endif %}
            </div>

            <p class="text-secondary mb-0" itemprop="description">
              {% if post.intro %}
                {{ post.intro|richtext|striptags|truncatechars:160 }}
              {% else %}
                {{ post.search_description|default:""|truncatechars:160 }}
              {% endif %}
            </p>
          </div>
        </article>
      </div>
      {% endwith %}
    {% endfor %}
  </div>
{% else %}
  <!-- ====================== EMPTY STATE ====================== -->
  <section class="text-center py-5 my-4 bg-light rounded-3">
    <p class="lead mb-1">Pas encore d’articles.</p>
    <p class="text-muted mb-0">Revenez bientôt pour découvrir nos nouvelles publications.</p>
  </section>
{% endif %}

<!-- ====================== PAGINATION ====================== -->
{% if posts and posts.paginator.num_pages > 1 %}
  <nav class="mt-4" aria-label="Pagination des articles">
    <ul class="pagination justify-content-center">
      {% if posts.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ posts.previous_page_number }}{% if request.GET.cat %}&cat={{ request.GET.cat|urlencode }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag|urlencode }}{% endif %}">
            Précédent
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Précédent</span></li>
      {% endif %}

      {% for num in posts.paginator.page_range %}
        {% if num == 1 or num == posts.paginator.num_pages or (num >= posts.number|add:'-2' and num <= posts.number|add:'2') %}
          <li class="page-item {% if num == posts.number %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}{% if request.GET.cat %}&cat={{ request.GET.cat|urlencode }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag|urlencode }}{% endif %}">{{ num }}</a>
          </li>
        {% elif forloop.first or forloop.last %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endfor %}

      {% if posts.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ posts.next_page_number }}{% if request.GET.cat %}&cat={{ request.GET.cat|urlencode }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag|urlencode }}{% endif %}">
            Suivant
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Suivant</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

{% endblock %}
