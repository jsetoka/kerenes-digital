{% extends "base.html" %}
{% block content %}

<section class="container py-4" style="max-width: 720px;">
  <h1 class="fw-bold mb-2">{{ page.title }}</h1>
  <p class="text-muted mb-4">Diagnostic complet • ~1 minute • 7 questions</p>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <small class="text-muted">Progression</small>
    <small class="text-muted" id="timeLeft">Il reste ~1 minute</small>
  </div>

  <div class="progress mb-4" style="height: 10px;">
    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 14%;"></div>
  </div>

  <form method="post" novalidate id="completForm">
    {% csrf_token %}

    <!-- STEP 1 -->
    <div class="step" data-step="1">
      <h5 class="mb-3">1/7 — {{ form.c1_risque_erreur.label }}</h5>
      {% for r in form.c1_risque_erreur %}
        <label class="d-block border rounded p-3 mb-2">{{ r.tag }} <span class="ms-2">{{ r.choice_label }}</span></label>
      {% endfor %}
      <div class="text-danger small">{{ form.c1_risque_erreur.errors }}</div>
    </div>

    <!-- STEP 2 -->
    <div class="step d-none" data-step="2">
      <h5 class="mb-3">2/7 — {{ form.c2_pertes.label }}</h5>
      {% for r in form.c2_pertes %}
        <label class="d-block border rounded p-3 mb-2">{{ r.tag }} <span class="ms-2">{{ r.choice_label }}</span></label>
      {% endfor %}
      <div class="text-danger small">{{ form.c2_pertes.errors }}</div>
    </div>

    <!-- STEP 3 -->
    <div class="step d-none" data-step="3">
      <h5 class="mb-3">3/7 — {{ form.c3_stockage_data.label }}</h5>
      {% for r in form.c3_stockage_data %}
        <label class="d-block border rounded p-3 mb-2">{{ r.tag }} <span class="ms-2">{{ r.choice_label }}</span></label>
      {% endfor %}
      <div class="text-danger small">{{ form.c3_stockage_data.errors }}</div>
    </div>

    <!-- STEP 4 -->
    <div class="step d-none" data-step="4">
      <h5 class="mb-3">4/7 — {{ form.c4_usage_ia.label }}</h5>
      {% for r in form.c4_usage_ia %}
        <label class="d-block border rounded p-3 mb-2">{{ r.tag }} <span class="ms-2">{{ r.choice_label }}</span></label>
      {% endfor %}
      <div class="text-danger small">{{ form.c4_usage_ia.errors }}</div>
    </div>

    <!-- STEP 5 -->
    <div class="step d-none" data-step="5">
      <h5 class="mb-3">5/7 — {{ form.c5_objectif.label }}</h5>
      {% for r in form.c5_objectif %}
        <label class="d-block border rounded p-3 mb-2">{{ r.tag }} <span class="ms-2">{{ r.choice_label }}</span></label>
      {% endfor %}
      <div class="text-danger small">{{ form.c5_objectif.errors }}</div>
    </div>

    <!-- STEP 6 -->
    <div class="step d-none" data-step="6">
      <h5 class="mb-3">6/7 — {{ form.c6_frequence_reporting.label }}</h5>
      {% for r in form.c6_frequence_reporting %}
        <label class="d-block border rounded p-3 mb-2">{{ r.tag }} <span class="ms-2">{{ r.choice_label }}</span></label>
      {% endfor %}
      <div class="text-danger small">{{ form.c6_frequence_reporting.errors }}</div>
    </div>

    <!-- STEP 7 -->
    <div class="step d-none" data-step="7">
      <h5 class="mb-3">7/7 — {{ form.c7_priorite_process.label }}</h5>
      {% for r in form.c7_priorite_process %}
        <label class="d-block border rounded p-3 mb-2">{{ r.tag }} <span class="ms-2">{{ r.choice_label }}</span></label>
      {% endfor %}
      <div class="text-danger small">{{ form.c7_priorite_process.errors }}</div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
      <button type="button" class="btn btn-outline-secondary" id="prevBtn" disabled>Retour</button>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" id="nextBtn">Suivant</button>
        <button type="submit" class="btn btn-success d-none" id="submitBtn">Voir mon résultat</button>
      </div>
    </div>
  </form>
</section>

<script>
(function () {
  const steps = Array.from(document.querySelectorAll(".step"));
  const progressBar = document.getElementById("progressBar");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const timeLeft = document.getElementById("timeLeft");

  let current = 1;

  function showStep(n) {
    steps.forEach(s => s.classList.add("d-none"));
    const active = steps.find(s => Number(s.dataset.step) === n);
    if (active) active.classList.remove("d-none");

    prevBtn.disabled = (n === 1);
    const isLast = (n === steps.length);
    nextBtn.classList.toggle("d-none", isLast);
    submitBtn.classList.toggle("d-none", !isLast);

    const pct = Math.round((n / steps.length) * 100);
    progressBar.style.width = pct + "%";

    // pseudo "time left"
    const remaining = steps.length - n;
    if (remaining >= 5) timeLeft.textContent = "Il reste ~1 minute";
    else if (remaining >= 2) timeLeft.textContent = "Il reste ~30 secondes";
    else timeLeft.textContent = "Dernières questions";
  }

  function stepHasSelection(n) {
    const active = steps.find(s => Number(s.dataset.step) === n);
    if (!active) return false;
    return !!active.querySelector("input[type='radio']:checked");
  }

  nextBtn.addEventListener("click", () => {
    if (!stepHasSelection(current)) {
      alert("Veuillez choisir une option pour continuer.");
      return;
    }
    current = Math.min(current + 1, steps.length);
    showStep(current);
  });

  prevBtn.addEventListener("click", () => {
    current = Math.max(current - 1, 1);
    showStep(current);
  });

  showStep(current);
})();
</script>

{% endblock %}