{% extends "base.html" %}
{% load wagtailcore_tags %}

{% block content %}
<section class="container py-5" style="max-width: 820px;">
  <h1 class="fw-bold">Affinons votre diagnostic (1 minute)</h1>
  <p class="text-muted mb-4">Encore 7 questions pour un résultat plus précis.</p>

  <div class="progress mb-4" style="height: 10px;">
    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 14%;" aria-valuemin="0" aria-valuemax="100"></div>
  </div>

  <form method="post" id="wizardForm" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

    <div class="wizard-step" data-step="1">
      <h5 class="mb-3">{{ form.q6.label }}</h5>
      {% if form.q6.errors %}<div class="text-danger mb-2">{{ form.q6.errors }}</div>{% endif %}
      {{ form.q6 }}
    </div>

    <div class="wizard-step d-none" data-step="2">
      <h5 class="mb-3">{{ form.q7.label }}</h5>
      {% if form.q7.errors %}<div class="text-danger mb-2">{{ form.q7.errors }}</div>{% endif %}
      {{ form.q7 }}
    </div>

    <div class="wizard-step d-none" data-step="3">
      <h5 class="mb-3">{{ form.q8.label }}</h5>
      {% if form.q8.errors %}<div class="text-danger mb-2">{{ form.q8.errors }}</div>{% endif %}
      {{ form.q8 }}
    </div>

    <div class="wizard-step d-none" data-step="4">
      <h5 class="mb-3">{{ form.q9.label }}</h5>
      {% if form.q9.errors %}<div class="text-danger mb-2">{{ form.q9.errors }}</div>{% endif %}
      {{ form.q9 }}
    </div>

    <div class="wizard-step d-none" data-step="5">
      <h5 class="mb-3">{{ form.q10.label }}</h5>
      {% if form.q10.errors %}<div class="text-danger mb-2">{{ form.q10.errors }}</div>{% endif %}
      {{ form.q10 }}
    </div>

    <div class="wizard-step d-none" data-step="6">
      <h5 class="mb-3">{{ form.q11.label }}</h5>
      {% if form.q11.errors %}<div class="text-danger mb-2">{{ form.q11.errors }}</div>{% endif %}
      {{ form.q11 }}
    </div>

    <div class="wizard-step d-none" data-step="7">
      <h5 class="mb-3">{{ form.q12.label }}</h5>
      {% if form.q12.errors %}<div class="text-danger mb-2">{{ form.q12.errors }}</div>{% endif %}
      {{ form.q12 }}
    </div>

    <div class="d-flex gap-2 mt-4">
      <button type="button" class="btn btn-outline-secondary" id="prevBtn" disabled>Précédent</button>
      <button type="button" class="btn btn-primary ms-auto" id="nextBtn">Suivant</button>
      <button type="submit" class="btn btn-success ms-auto d-none" id="submitBtn">Terminer</button>
    </div>

    <p class="text-muted mt-3" style="font-size:0.9rem;">
      Question <span id="stepLabel">1</span> / 7
    </p>
  </form>
</section>

<script>
(function () {
  const form = document.getElementById("wizardForm");
  const steps = Array.from(document.querySelectorAll(".wizard-step"));
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const stepLabel = document.getElementById("stepLabel");
  const progressBar = document.getElementById("progressBar");

  const totalSteps = steps.length;
  let current = 1;

  function showStep(n) {
    steps.forEach(s => s.classList.add("d-none"));
    const el = steps.find(s => Number(s.dataset.step) === n);
    if (el) el.classList.remove("d-none");

    prevBtn.disabled = n === 1;

    if (n === totalSteps) {
      nextBtn.classList.add("d-none");
      submitBtn.classList.remove("d-none");
      submitBtn.textContent = "Voir mon résultat";
    } else {
      nextBtn.classList.remove("d-none");
      submitBtn.classList.add("d-none");
    }

    stepLabel.textContent = String(n);
    const pct = Math.round((n / totalSteps) * 100);
    progressBar.style.width = pct + "%";
    progressBar.setAttribute("aria-valuenow", String(pct));
  }

  function isStepAnswered(n) {
    const stepEl = steps.find(s => Number(s.dataset.step) === n);
    if (!stepEl) return true;

    const radios = stepEl.querySelectorAll('input[type="radio"]');
    if (radios.length) return Array.from(radios).some(r => r.checked);

    const inputs = stepEl.querySelectorAll("input, select, textarea");
    return Array.from(inputs).every(i => (i.value || "").trim().length > 0);
  }

  nextBtn.addEventListener("click", function () {
    if (!isStepAnswered(current)) {
      alert("Veuillez répondre à la question avant de continuer.");
      return;
    }
    if (current < totalSteps) {
      current += 1;
      showStep(current);
    }
  });

  prevBtn.addEventListener("click", function () {
    if (current > 1) {
      current -= 1;
      showStep(current);
    }
  });

  function goToFirstErrorStep() {
    const errorBlock = form.querySelector(".text-danger, .errorlist");
    if (!errorBlock) return;
    for (const stepEl of steps) {
      if (stepEl.querySelector(".text-danger, .errorlist")) {
        current = Number(stepEl.dataset.step);
        showStep(current);
        break;
      }
    }
  }

  showStep(current);
  goToFirstErrorStep();
})();
</script>
{% endblock %}