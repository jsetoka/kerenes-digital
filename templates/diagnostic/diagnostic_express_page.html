{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="container py-4" style="max-width: 720px;">
  <h1 class="fw-bold mb-2">{{ page.title }}</h1>
  <p class="text-muted mb-4">Diagnostic express • 1 minute • 5 questions</p>

  <!-- Progress -->
  <div class="progress mb-4" style="height: 10px;">
    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
  </div>

  <form method="post" novalidate id="expressForm">
    {% csrf_token %}

    <!-- Erreurs globales -->
    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}

    <!-- STEP 1 -->
    <div class="step" data-step="1">
      <h5 class="mb-3">1/5 — {{ form.q1_secteur.label }}</h5>
      {% for radio in form.q1_secteur %}
        <label class="d-block border rounded p-3 mb-2">
          {{ radio.tag }} <span class="ms-2">{{ radio.choice_label }}</span>
        </label>
      {% endfor %}
      <div class="text-danger small">{{ form.q1_secteur.errors }}</div>
    </div>

    <!-- STEP 2 -->
    <div class="step d-none" data-step="2">
      <h5 class="mb-3">2/5 — {{ form.q2_taille.label }}</h5>
      {% for radio in form.q2_taille %}
        <label class="d-block border rounded p-3 mb-2">
          {{ radio.tag }} <span class="ms-2">{{ radio.choice_label }}</span>
        </label>
      {% endfor %}
      <div class="text-danger small">{{ form.q2_taille.errors }}</div>
    </div>

    <!-- STEP 3 -->
    <div class="step d-none" data-step="3">
      <h5 class="mb-3">3/5 — {{ form.q3_fonction.label }}</h5>
      {% for radio in form.q3_fonction %}
        <label class="d-block border rounded p-3 mb-2">
          {{ radio.tag }} <span class="ms-2">{{ radio.choice_label }}</span>
        </label>
      {% endfor %}
      <div class="text-danger small">{{ form.q3_fonction.errors }}</div>
    </div>

    <!-- STEP 4 -->
    <div class="step d-none" data-step="4">
      <h5 class="mb-3">4/5 — {{ form.q4_urgence.label }}</h5>
      {% for radio in form.q4_urgence %}
        <label class="d-block border rounded p-3 mb-2">
          {{ radio.tag }} <span class="ms-2">{{ radio.choice_label }}</span>
        </label>
      {% endfor %}
      <div class="text-danger small">{{ form.q4_urgence.errors }}</div>
    </div>

    <!-- STEP 5 -->
    <div class="step d-none" data-step="5">
      <h5 class="mb-3">5/5 — {{ form.q5_donnees.label }}</h5>
      {% for radio in form.q5_donnees %}
        <label class="d-block border rounded p-3 mb-2">
          {{ radio.tag }} <span class="ms-2">{{ radio.choice_label }}</span>
        </label>
      {% endfor %}
      <div class="text-danger small">{{ form.q5_donnees.errors }}</div>
    </div>

    <!-- Nav buttons -->
    <div class="d-flex justify-content-between align-items-center mt-4">
      <button type="button" class="btn btn-outline-secondary" id="prevBtn" disabled>Retour</button>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary" id="nextBtn">Suivant</button>
        <button type="submit" class="btn btn-success d-none" id="submitBtn">Continuer</button>
      </div>
    </div>

    <p class="text-muted small mt-3 mb-0">
      Astuce : à la fin, on te demandera juste ton contact pour t’envoyer l’estimation.
    </p>
  </form>
</section>

<script>
(function () {
  const steps = Array.from(document.querySelectorAll(".step"));
  const progressBar = document.getElementById("progressBar");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");

  let current = 1;

  function showStep(n) {
    steps.forEach(step => step.classList.add("d-none"));
    const active = steps.find(s => Number(s.dataset.step) === n);
    if (active) active.classList.remove("d-none");

    // Buttons
    prevBtn.disabled = (n === 1);
    const isLast = (n === steps.length);
    nextBtn.classList.toggle("d-none", isLast);
    submitBtn.classList.toggle("d-none", !isLast);

    // Progress: 1->20%, 2->40%, ... 5->100%
    const pct = Math.round((n / steps.length) * 100);
    progressBar.style.width = pct + "%";
    progressBar.setAttribute("aria-valuenow", String(pct));
  }

  function stepHasSelection(n) {
    const active = steps.find(s => Number(s.dataset.step) === n);
    if (!active) return false;
    const checked = active.querySelector("input[type='radio']:checked");
    return !!checked;
  }

  nextBtn.addEventListener("click", () => {
    if (!stepHasSelection(current)) {
      // mini feedback UX
      alert("Veuillez choisir une option pour continuer.");
      return;
    }
    current = Math.min(current + 1, steps.length);
    showStep(current);
  });

  prevBtn.addEventListener("click", () => {
    current = Math.max(current - 1, 1);
    showStep(current);
  });

  // Si le serveur renvoie des erreurs (POST invalide),
  // on essaie de revenir sur la première question en erreur.
  const errorFields = document.querySelectorAll(".text-danger.small:not(:empty)");
  if (errorFields.length > 0) {
    // Trouver le premier step ayant une erreur
    let firstErrorStep = 1;
    steps.forEach(s => {
      if (s.querySelector(".text-danger.small") && s.querySelector(".text-danger.small").textContent.trim() !== "") {
        firstErrorStep = Number(s.dataset.step);
      }
    });
    current = firstErrorStep;
  }

  showStep(current);
})();
</script>
{% endblock %}